name: Release Preparation

on:
  push:
    branches: [release/*]
    tags: ["v*"]

jobs:
  version-check:
    name: Version Consistency Check
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: |
          set -euo pipefail
          if [ -d "/Applications/Xcode_16.1.app/Contents/Developer" ]; then
            sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer
          elif [ -d "/Applications/Xcode.app/Contents/Developer" ]; then
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          else
            echo "‚ùå No Xcode installation found under /Applications"
            ls -la /Applications | sed -n '1,200p'
            exit 1
          fi

      - name: Extract version from project
        id: version
        run: |
          VERSION=$(xcodebuild -project OpenResponses.xcodeproj -showBuildSettings 2>/dev/null | grep "MARKETING_VERSION" | head -1 | awk '{print $3}')
          BUILD=$(xcodebuild -project OpenResponses.xcodeproj -showBuildSettings 2>/dev/null | grep "CURRENT_PROJECT_VERSION" | head -1 | awk '{print $3}')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "build=${BUILD}" >> $GITHUB_OUTPUT
          echo "üì¶ Version: ${VERSION} (Build ${BUILD})"

      - name: Check release notes exist
        run: |
          if [ -f "docs/ReleaseNotes_${{ steps.version.outputs.version }}.md" ]; then
            echo "‚úÖ Release notes found for version ${{ steps.version.outputs.version }}"
          else
            echo "‚ö†Ô∏è No release notes found for version ${{ steps.version.outputs.version }}"
            echo "Expected: docs/ReleaseNotes_${{ steps.version.outputs.version }}.md"
            exit 1
          fi

      - name: Verify PRIVACY.md exists
        run: |
          if [ -f "PRIVACY.md" ]; then
            echo "‚úÖ Privacy policy exists"
          else
            echo "‚ùå PRIVACY.md is required for App Store submission"
            exit 1
          fi

      - name: Check for TODO/FIXME in release
        run: |
          if grep -r "TODO:\|FIXME:" --include="*.swift" OpenResponses/; then
            echo "‚ö†Ô∏è Found TODO/FIXME comments in code"
            echo "Consider resolving these before release"
          else
            echo "‚úÖ No TODO/FIXME comments found"
          fi

  archive-build:
    name: Create Archive Build
    runs-on: macos-14
    needs: version-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: |
          set -euo pipefail
          if [ -d "/Applications/Xcode_16.1.app/Contents/Developer" ]; then
            sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer
          elif [ -d "/Applications/Xcode.app/Contents/Developer" ]; then
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          else
            echo "‚ùå No Xcode installation found under /Applications"
            ls -la /Applications | sed -n '1,200p'
            exit 1
          fi

      - name: Build archive (unsigned)
        run: |
          xcodebuild archive \
            -project OpenResponses.xcodeproj \
            -scheme OpenResponses \
            -archivePath ./build/OpenResponses.xcarchive \
            -destination 'generic/platform=iOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee build.log || true

          if [ -d "./build/OpenResponses.xcarchive" ]; then
            echo "‚úÖ Archive created successfully"
          else
            echo "‚ö†Ô∏è  Archive creation had issues, see log"
            tail -50 build.log
          fi
        continue-on-error: true

      - name: Archive size check
        run: |
          if [ -d "./build/OpenResponses.xcarchive" ]; then
            SIZE=$(du -sh ./build/OpenResponses.xcarchive | cut -f1)
            echo "üì¶ Archive size: ${SIZE}"
          fi

  documentation-check:
    name: Documentation Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required documentation
        run: |
          echo "üìö Checking required documentation..."

          REQUIRED_DOCS=(
            "README.md"
            "LICENSE"
            "PRIVACY.md"
            "docs/ROADMAP.md"
            "docs/AppStoreMetadata.md"
            "docs/AppStoreReleasePlan.md"
          )

          MISSING=0
          for doc in "${REQUIRED_DOCS[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "‚ùå Missing: $doc"
              MISSING=1
            else
              echo "‚úÖ Found: $doc"
            fi
          done

          if [ $MISSING -eq 1 ]; then
            exit 1
          fi

          echo ""
          echo "‚úÖ All required documentation present"

      - name: Validate links in documentation
        run: |
          echo "üîó Checking for broken internal links..."

          # Check if any referenced files in markdown don't exist
          for md in $(find . -name "*.md"); do
            echo "Checking: $md"
            grep -oP '\[.*?\]\(\K[^)]+(?=\))' "$md" 2>/dev/null | while read link; do
              # Skip external URLs
              if [[ $link == http* ]] || [[ $link == #* ]]; then
                continue
              fi

              # Resolve relative path
              dir=$(dirname "$md")
              target="$dir/$link"

              if [ ! -f "$target" ] && [ ! -d "$target" ]; then
                echo "‚ö†Ô∏è  Broken link in $md: $link"
              fi
            done
          done

          echo "‚úÖ Link validation complete"

  app-store-readiness:
    name: App Store Readiness Check
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Info.plist privacy descriptions
        run: |
          echo "üîê Checking privacy descriptions..."

          REQUIRED_KEYS=(
            "NSCalendarsUsageDescription"
            "NSContactsUsageDescription"
            "NSPhotoLibraryUsageDescription"
            "NSRemindersUsageDescription"
          )

          for key in "${REQUIRED_KEYS[@]}"; do
            if xcodebuild -project OpenResponses.xcodeproj -showBuildSettings 2>/dev/null | grep -q "INFOPLIST_KEY_${key}"; then
              echo "‚úÖ Found: $key"
            else
              echo "‚ö†Ô∏è  Missing: $key"
            fi
          done

      - name: Check for app icon
        run: |
          if [ -f "OpenResponses/Resources/Assets/Assets.xcassets/AppIcon.appiconset/Contents.json" ]; then
            echo "‚úÖ AppIcon asset catalog found"

            # Check if 1024x1024 icon exists
            if cat OpenResponses/Resources/Assets/Assets.xcassets/AppIcon.appiconset/Contents.json | grep -q "1024"; then
              echo "‚úÖ 1024x1024 app icon specified"
            else
              echo "‚ö†Ô∏è  No 1024x1024 app icon found"
            fi
          else
            echo "‚ùå AppIcon asset catalog not found"
            exit 1
          fi

      - name: Verify bundle ID
        run: |
          BUNDLE_ID=$(xcodebuild -project OpenResponses.xcodeproj -showBuildSettings 2>/dev/null | grep "PRODUCT_BUNDLE_IDENTIFIER" | head -1 | awk '{print $3}')
          echo "üì¶ Bundle ID: ${BUNDLE_ID}"

          if [[ $BUNDLE_ID == *.* ]]; then
            echo "‚úÖ Bundle ID format valid"
          else
            echo "‚ùå Invalid bundle ID format"
            exit 1
          fi

      - name: Check deployment target
        run: |
          TARGET=$(xcodebuild -project OpenResponses.xcodeproj -showBuildSettings 2>/dev/null | grep "IPHONEOS_DEPLOYMENT_TARGET" | head -1 | awk '{print $3}')
          echo "üì± Deployment Target: iOS ${TARGET}"

          # Ensure it's iOS 17.0 as per requirements
          if [[ $TARGET == "17.0" ]]; then
            echo "‚úÖ Deployment target matches requirements"
          else
            echo "‚ö†Ô∏è  Deployment target is $TARGET (expected 17.0)"
          fi
